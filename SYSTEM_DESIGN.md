# URL Shortener System Design

## 1. 系统设计概述

本项目实现了一个完整的短链接系统，遵循 "Grokking the System Design Interview" 的设计思路，包含了从需求分析到实际部署的完整流程。

## 2. 需求分析

### 2.1 功能需求
- **URL缩短**: 将长URL转换为短URL
- **URL重定向**: 通过短URL访问原始URL
- **自定义别名**: 支持用户自定义短URL
- **过期时间**: 支持设置URL过期时间
- **统计功能**: 点击次数统计和分析
- **管理功能**: URL的增删改查

### 2.2 非功能需求
- **高可用性**: 99.9%+ 可用性
- **低延迟**: <100ms 响应时间
- **高并发**: 支持10K+ QPS
- **可扩展性**: 水平扩展能力
- **数据一致性**: 强一致性保证

## 3. 容量估算

### 3.1 流量估算
- 日活跃用户: 1M
- 每用户每日创建URL: 0.1个
- 每日新URL: 100K
- 读写比例: 100:1
- 每日读取: 10M
- QPS: 读取 ~115, 写入 ~1.2

### 3.2 存储估算
- 每个URL记录: ~500 bytes
- 5年数据: 100K * 365 * 5 = 182.5M 记录
- 总存储: 182.5M * 500B ≈ 91GB

## 4. 系统架构

### 4.1 整体架构
```
┌─────────────────┐
│   Load Balancer │
│    (Ingress)    │
└─────────┬───────┘
          │
    ┌─────▼─────┐
    │    CDN    │
    └─────┬─────┘
          │
┌─────────▼─────────┐
│   Web Servers     │
│  (Spring Boot)    │
└─────────┬─────────┘
          │
    ┌─────▼─────┐
    │   Cache   │
    │(Caffeine) │
    └─────┬─────┘
          │
    ┌─────▼─────┐
    │ Database  │
    │  (MySQL)  │
    └───────────┘
```

### 4.2 核心组件

#### 4.2.1 Web层
- **Spring Boot**: 主要框架
- **Spring MVC**: REST API
- **Spring Data JPA**: 数据访问
- **Spring Cache**: 缓存抽象

#### 4.2.2 服务层
- **UrlShortenerService**: 核心业务逻辑
- **Base62Encoder**: URL编码算法
- **缓存策略**: 多级缓存

#### 4.2.3 数据层
- **MySQL**: 主数据库
- **Caffeine**: 本地缓存
- **连接池**: HikariCP

## 5. 数据库设计

### 5.1 表结构
```sql
CREATE TABLE url_mapping (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    short_url VARCHAR(10) NOT NULL UNIQUE,
    long_url TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NULL,
    click_count BIGINT DEFAULT 0,
    INDEX idx_short_url (short_url),
    INDEX idx_created_at (created_at),
    INDEX idx_expires_at (expires_at)
);
```

### 5.2 索引策略
- **主键索引**: id (聚簇索引)
- **唯一索引**: short_url (快速查找)
- **普通索引**: created_at (时间范围查询)
- **普通索引**: expires_at (过期清理)

## 6. 算法设计

### 6.1 短URL生成算法

#### 6.1.1 Base62编码
- 字符集: [0-9a-zA-Z] (62个字符)
- 长度: 7位 (62^7 ≈ 3.5万亿组合)
- 碰撞处理: 重试机制

#### 6.1.2 生成流程
```
1. 生成随机数
2. Base62编码
3. 检查唯一性
4. 如果冲突，重新生成
5. 最多重试5次
```

### 6.2 缓存策略

#### 6.2.1 缓存层次
- **L1**: 本地缓存 (Caffeine)
- **L2**: 分布式缓存 (Redis, 可选)

#### 6.2.2 缓存策略
- **Cache-Aside**: 旁路缓存
- **TTL**: 30分钟过期
- **LRU**: 最近最少使用淘汰

## 7. 高可用设计

### 7.1 无状态设计
- 应用服务器无状态
- 会话信息存储在缓存/数据库
- 支持水平扩展

### 7.2 故障处理
- **健康检查**: Spring Actuator
- **熔断器**: 可配置
- **重试机制**: 指数退避
- **降级策略**: 返回默认值

### 7.3 监控告警
- **指标监控**: Prometheus + Grafana
- **日志监控**: ELK Stack
- **链路追踪**: Jaeger (可选)

## 8. 性能优化

### 8.1 数据库优化
- **索引优化**: 覆盖索引
- **查询优化**: 避免全表扫描
- **连接池**: HikariCP配置
- **读写分离**: 主从复制

### 8.2 缓存优化
- **预热策略**: 热点数据预加载
- **缓存穿透**: 布隆过滤器
- **缓存雪崩**: 随机TTL
- **缓存击穿**: 分布式锁

### 8.3 应用优化
- **异步处理**: 统计更新异步化
- **批量操作**: 批量插入/更新
- **连接复用**: HTTP Keep-Alive
- **压缩**: Gzip压缩

## 9. 安全设计

### 9.1 输入验证
- **URL格式验证**: 正则表达式
- **长度限制**: 防止过长输入
- **字符过滤**: 防止注入攻击

### 9.2 访问控制
- **频率限制**: 防止滥用
- **IP白名单**: 管理接口保护
- **HTTPS**: 传输加密

### 9.3 数据保护
- **SQL注入防护**: 参数化查询
- **XSS防护**: 输出编码
- **CSRF防护**: Token验证

## 10. 部署架构

### 10.1 Kubernetes部署
```yaml
# 部署组件
- Namespace: 资源隔离
- ConfigMap: 配置管理
- Secret: 敏感信息
- Deployment: 应用部署
- Service: 服务发现
- Ingress: 外部访问
- HPA: 自动扩缩容
```

### 10.2 容器化
- **多阶段构建**: 减小镜像大小
- **非root用户**: 安全运行
- **健康检查**: 容器状态监控
- **资源限制**: CPU/内存限制

## 11. 测试策略

### 11.1 测试金字塔
- **单元测试**: 70% 覆盖率
- **集成测试**: API测试
- **端到端测试**: 完整流程测试

### 11.2 测试类型
- **功能测试**: 业务逻辑验证
- **性能测试**: 压力测试
- **安全测试**: 漏洞扫描
- **兼容性测试**: 浏览器兼容

## 12. 扩展性考虑

### 12.1 水平扩展
- **无状态设计**: 支持多实例
- **负载均衡**: 请求分发
- **数据分片**: 分库分表
- **微服务**: 服务拆分

### 12.2 垂直扩展
- **资源配置**: CPU/内存调优
- **JVM调优**: GC参数优化
- **数据库调优**: 参数优化

## 13. 监控指标

### 13.1 业务指标
- **URL创建数**: 每日/每小时
- **点击数**: 总计/平均
- **转换率**: 点击/创建比例
- **热门URL**: Top N统计

### 13.2 技术指标
- **响应时间**: P50/P95/P99
- **吞吐量**: QPS/TPS
- **错误率**: 4xx/5xx比例
- **资源使用**: CPU/内存/磁盘

## 14. 运维考虑

### 14.1 日志管理
- **结构化日志**: JSON格式
- **日志级别**: 分级记录
- **日志轮转**: 防止磁盘满
- **日志聚合**: 集中管理

### 14.2 备份恢复
- **数据备份**: 定期全量/增量
- **配置备份**: 版本控制
- **恢复测试**: 定期演练
- **RTO/RPO**: 恢复目标

## 15. 成本优化

### 15.1 资源优化
- **按需扩缩**: 根据负载调整
- **资源池化**: 共享资源
- **冷热分离**: 数据分层存储
- **CDN**: 减少带宽成本

### 15.2 运维优化
- **自动化**: 减少人工成本
- **监控告警**: 提前发现问题
- **容量规划**: 避免过度配置

## 16. 总结

本系统设计遵循了现代分布式系统的最佳实践，具备以下特点：

1. **完整性**: 从需求到部署的完整方案
2. **可扩展性**: 支持水平和垂直扩展
3. **高可用性**: 多层次的可用性保障
4. **高性能**: 多级缓存和优化策略
5. **安全性**: 全方位的安全防护
6. **可维护性**: 完善的监控和运维体系

该设计可以支撑大规模的短链接服务，并为后续的功能扩展提供了良好的基础。